version: '3.8'

# ============================================================================
# Zurg Broken Torrent Monitor - Docker Compose
# ============================================================================
# Production-ready Docker Compose configuration
# 
# Quick Start:
#   1. Copy .env.sample to .env and edit values
#   2. mkdir -p config logs
#   3. cp zurg-monitor.conf config/
#   4. docker-compose up -d
# ============================================================================

services:
  # ============================================================================
  # Default Configuration
  # Uses environment variables from .env file
  # ============================================================================
  zurg-monitor:
    image: zurg-monitor:latest
    container_name: zurg-monitor
    restart: unless-stopped
    
    # User/Group settings (from .env file)
    user: "${PUID}:${PGID}"
    
    # Mount volumes for persistent data
    volumes:
      - ./config:/config
      - ./logs:/logs
    
    # Environment variables (load from .env file)
    environment:
      # Zurg connection
      - ZURG_URL=${ZURG_URL:-http://zurg:9999}
      - ZURG_USERNAME=${ZURG_USERNAME:-}
      - ZURG_PASSWORD=${ZURG_PASSWORD:-}
      
      # User/Group IDs
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      
      # Monitoring settings
      - CHECK_INTERVAL=${CHECK_INTERVAL:-30}
      - RATE_LIMIT=${RATE_LIMIT:-10}
      
      # Runtime options
      - RUN_ONCE=${RUN_ONCE:-false}
      - VERBOSE=${VERBOSE:-false}
      - DEBUG=${DEBUG:-false}
      - TRACE=${TRACE:-false}
      - DRY_RUN=${DRY_RUN:-false}
      
      # Timezone
      - TZ=${TZ:-UTC}
    
    # Network configuration
    networks:
      - zurg-network
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Health check
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 5m
      timeout: 30s
      retries: 3
      start_period: 30s

  # ============================================================================
  # Example: Run Once Mode (for testing)
  # Usage: docker-compose --profile testing up zurg-monitor-once
  # ============================================================================
  zurg-monitor-once:
    image: zurg-monitor:latest
    container_name: zurg-monitor-once
    profiles:
      - testing
    
    user: "${PUID}:${PGID}"
    
    volumes:
      - ./config:/config
      - ./logs:/logs
    
    environment:
      - ZURG_URL=${ZURG_URL:-http://zurg:9999}
      - ZURG_USERNAME=${ZURG_USERNAME:-}
      - ZURG_PASSWORD=${ZURG_PASSWORD:-}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - RUN_ONCE=true
      - VERBOSE=true
      - DEBUG=true
      - TZ=${TZ:-UTC}
    
    networks:
      - zurg-network

  # ============================================================================
  # Example: Dry Run Mode (for testing without repairs)
  # Usage: docker-compose --profile testing up zurg-monitor-dryrun
  # ============================================================================
  zurg-monitor-dryrun:
    image: zurg-monitor:latest
    container_name: zurg-monitor-dryrun
    profiles:
      - testing
    
    user: "${PUID}:${PGID}"
    
    volumes:
      - ./config:/config
      - ./logs:/logs
    
    environment:
      - ZURG_URL=${ZURG_URL:-http://zurg:9999}
      - ZURG_USERNAME=${ZURG_USERNAME:-}
      - ZURG_PASSWORD=${ZURG_PASSWORD:-}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - RUN_ONCE=true
      - DRY_RUN=true
      - VERBOSE=true
      - DEBUG=true
      - TZ=${TZ:-UTC}
    
    networks:
      - zurg-network

  # ============================================================================
  # Example: High Frequency Monitoring
  # Usage: docker-compose --profile fast up -d zurg-monitor-fast
  # ============================================================================
  zurg-monitor-fast:
    image: zurg-monitor:latest
    container_name: zurg-monitor-fast
    restart: unless-stopped
    profiles:
      - fast
    
    user: "${PUID}:${PGID}"
    
    volumes:
      - ./config:/config
      - ./logs:/logs
    
    environment:
      - ZURG_URL=${ZURG_URL:-http://zurg:9999}
      - ZURG_USERNAME=${ZURG_USERNAME:-}
      - ZURG_PASSWORD=${ZURG_PASSWORD:-}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - CHECK_INTERVAL=10
      - RATE_LIMIT=20
      - VERBOSE=true
      - DEBUG=true
      - TZ=${TZ:-UTC}
    
    networks:
      - zurg-network

  # ============================================================================
  # Example: Zurg Service (if you want to run Zurg in the same compose)
  # Uncomment to use
  # ============================================================================
  # zurg:
  #   image: ghcr.io/debridmediamanager/zurg-testing:latest
  #   container_name: zurg
  #   restart: unless-stopped
  #   
  #   user: "${PUID}:${PGID}"
  #   
  #   volumes:
  #     - ./zurg-config:/app/config
  #     - ./zurg-data:/app/data
  #   
  #   ports:
  #     - "9999:9999"
  #   
  #   environment:
  #     - PUID=${PUID:-1000}
  #     - PGID=${PGID:-1000}
  #     - ZURG_PORT=9999
  #     - TZ=${TZ:-UTC}
  #   
  #   networks:
  #     - zurg-network

# ============================================================================
# Networks
# ============================================================================
networks:
  zurg-network:
    name: zurg-network
    driver: bridge

# ============================================================================
# USAGE INSTRUCTIONS
# ============================================================================
#
# 1. Setup environment:
#    cp .env.sample .env
#    nano .env  # Edit your settings
#
# 2. Create directories:
#    mkdir -p config logs
#
# 3. Create configuration:
#    cp zurg-monitor.conf config/
#    nano config/zurg-monitor.conf  # Edit your settings
#
# 4. Build the image:
#    docker-compose build
#
# 5. Start the service:
#    docker-compose up -d
#
# 6. View logs:
#    docker-compose logs -f zurg-monitor
#
# 7. Stop the service:
#    docker-compose down
#
# ============================================================================
# USING PROFILES
# ============================================================================
#
# Run once for testing:
#    docker-compose --profile testing up zurg-monitor-once
#
# Dry run mode:
#    docker-compose --profile testing up zurg-monitor-dryrun
#
# High frequency monitoring:
#    docker-compose --profile fast up -d zurg-monitor-fast
#
# ============================================================================